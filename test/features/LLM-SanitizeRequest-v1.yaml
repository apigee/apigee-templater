name: Feature-LLM-SanitizeRequest-v1
type: feature
description: Proxy for Feature-LLM-SanitizeRequest-v1
parameters:
  - name: TEMPLATE_ID
    description: Configuration input for TEMPLATE_ID
    default: projects/apigee-prod13/locations/europe-west1/templates/default-ma-template
    examples: []
endpointFlows:
  - name: PreFlow
    mode: Request
    steps:
      - name: SUP-SanitizeRequest
      - name: RF-ArmorFault
        condition: SanitizeUserPrompt.SUP-SanitizeRequest.filterMatchState = "MATCH_FOUND"
      - name: JS-LogModelArmor
targetFlows: []
endpoints: []
targets: []
policies:
  - name: JS-LogModelArmor
    type: Javascript
    content:
      Javascript:
        _attributes:
          continueOnError: "false"
          enabled: "true"
          timeLimit: "200"
          name: JS-LogModelArmor
        DisplayName:
          _text: JS-LogModelArmor
        Properties: {}
        ResourceURL:
          _text: jsc://log-modal-armor.js
  - name: RF-ArmorFault
    type: RaiseFault
    content:
      RaiseFault:
        _attributes:
          continueOnError: "false"
          enabled: "true"
          name: RF-ArmorFault
        DisplayName:
          _text: RF-ArmorFault
        Properties: {}
        FaultResponse:
          Set:
            Headers: {}
            Payload:
              _attributes:
                contentType: text/plain
            StatusCode:
              _text: "500"
            ReasonPhrase:
              _text: Server Error
        IgnoreUnresolvedVariables:
          _text: "true"
  - name: SUP-SanitizeRequest
    type: SanitizeUserPrompt
    content:
      SanitizeUserPrompt:
        _attributes:
          async: "false"
          continueOnError: "false"
          enabled: "true"
          name: SUP-SanitizeRequest
        IgnoreUnresolvedVariables:
          _text: "false"
        DisplayName:
          _text: SUP-SanitizeRequest
        ModelArmor:
          TemplateName:
            _text: "{propertyset.model-armor.TEMPLATE_ID}"
        UserPromptSource:
          _text: "{jsonPath('$.contents[-1].parts[-1].text',request.content,true)}"
resources:
  - name: log-modal-armor.js
    type: jsc
    content: >-
      var mainfo =
      context.getVariable("SanitizeUserPrompt.SUP-SanitizeRequest");


      if (mainfo) print(JSON.stringify(mainfo));

      else print("No MA info found");
  - name: model-armor.properties
    type: properties
    content: TEMPLATE_ID=projects/apigee-prod13/locations/europe-west1/templates/default-ma-template
