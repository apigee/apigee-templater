name: MODEL-Gemini-v1
type: feature
description: |
  This feature adds an endpoints with basepath at v1/gemini, and proxies
  requests to the Vertex AI Gemini endpoint in a configured region.

  ## Proxy inputs
  None.
parameters:
  - name: PROJECT_ID
    displayName: PROJECT_ID
    description: The GCP project id that should be used for the Vertex AI Gemini endpoint.
    default: apigee-prod13
    examples: []
  - name: REGION
    displayName: REGION
    description: The GCP region that should be used for the Vertex AI Gemini endpoint.
    default: europe-west1
    examples:
      - europe-west1
      - us-east1
  - name: MODEL_ID
    displayName: MODEL_ID
    description: The Gemini model to use for the request.
    default: gemini-2.5-flash
    examples:
      - gemini-2.5-flash
      - gemini-2.5-pro
endpointFlows: []
targetFlows: []
endpoints:
  - name: gemini
    basePath: /v1/gemini
    routes:
      - name: default
        target: gemini
    flows:
      - name: PreFlow
        mode: Request
        steps:
          - name: EV-ExtractPrompt
    faultRules: []
targets:
  - name: gemini
    url: https://{propertyset.gemini.REGION}-aiplatform.googleapis.com/v1/projects/{propertyset.gemini.PROJECT_ID}/locations/{propertyset.gemini.REGION}/publishers/google/models/{propertyset.gemini.MODEL_ID}:generateContent
    auth: GoogleAccessToken
    scopes:
      - https://www.googleapis.com/auth/cloud-platform
    flows:
      - name: PostFlow
        mode: Response
        steps:
          - name: EV-StoreModelInfo
      - name: EventFlow
        mode: Response
        steps: []
    faultRules: []
    httpTargetConnection:
      Properties: {}
      URL:
        _text: https://{propertyset.gemini.REGION}-aiplatform.googleapis.com/v1/projects/{propertyset.gemini.PROJECT_ID}/locations/{propertyset.gemini.REGION}/publishers/google/models/{propertyset.gemini.MODEL_ID}:generateContent
      Authentication:
        GoogleAccessToken:
          Scopes:
            Scope:
              _text: https://www.googleapis.com/auth/cloud-platform
policies:
  - name: EV-ExtractPrompt
    type: ExtractVariables
    content:
      ExtractVariables:
        _attributes:
          continueOnError: "false"
          enabled: "true"
          name: EV-ExtractPrompt
        DisplayName:
          _text: EV-ExtractPrompt
        Properties: {}
        IgnoreUnresolvedVariables:
          _text: "true"
        JSONPayload:
          Variable:
            _attributes:
              name: promptInput
            JSONPath:
              _text: $.contents[-1].parts[-1].text
        Source:
          _attributes:
            clearPayload: "false"
          _text: request
        VariablePrefix:
          _text: llm
  - name: EV-StoreModelInfo
    type: ExtractVariables
    content:
      ExtractVariables:
        _attributes:
          continueOnError: "false"
          enabled: "true"
          name: EV-StoreModelInfo
        DisplayName:
          _text: EV-StoreModelInfo
        Properties: {}
        IgnoreUnresolvedVariables:
          _text: "true"
        Variable:
          _attributes:
            name: model
          Pattern:
            _text: "{propertyset.gemini.MODEL_ID}"
        JSONPayload:
          Variable:
            - _attributes:
                name: promptTokenCount
              JSONPath:
                _text: $.usage.prompt_tokens
            - _attributes:
                name: responseTokenCount
              JSONPath:
                _text: $.usage.completion_tokens
            - _attributes:
                name: totalTokenCount
              JSONPath:
                _text: $.usage.total_tokens
        Source:
          _attributes:
            clearPayload: "false"
          _text: response
        VariablePrefix:
          _text: llm
resources:
  - name: gemini.properties
    type: properties
    content: |-
      PROJECT_ID=apigee-prod13
      REGION=europe-west1
      MODEL_ID=gemini-2.5-flash
