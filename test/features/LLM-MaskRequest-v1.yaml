name: Feature-LLM-MaskRequest-v1
type: feature
description: Proxy for Feature-LLM-MaskRequest-v1
parameters:
  - name: PROJECT_ID
    description: Configuration input for PROJECT_ID
    default: apigee-prod13
    examples: []
endpointFlows:
  - name: PreFlow
    mode: Request
    steps:
      - name: SC-SensitiveDataProtection
      - name: JS-SetMaskedRequest
targetFlows: []
endpoints: []
targets: []
policies:
  - name: JS-SetMaskedRequest
    type: Javascript
    content:
      Javascript:
        _attributes:
          continueOnError: "false"
          enabled: "true"
          timeLimit: "200"
          name: JS-SetMaskedRequest
        DisplayName:
          _text: JS-SetMaskedRequest
        Properties: {}
        ResourceURL:
          _text: jsc://SetRequest.js
  - name: SC-SensitiveDataProtection
    type: ServiceCallout
    content:
      ServiceCallout:
        _attributes:
          continueOnError: "false"
          enabled: "true"
          name: SC-SensitiveDataProtection
        DisplayName:
          _text: SC-SensitiveDataProtection
        Properties: {}
        Request:
          _attributes:
            clearPayload: "true"
            variable: myRequest
          IgnoreUnresolvedVariables:
            _text: "false"
          Set:
            Verb:
              _text: POST
            Payload:
              _attributes:
                contentType: application/json
              _text: "

                \        {

                \          \"item\": {

                \            \"value\":
                \"{jsonPath('$.contents[-1].parts[-1].text',request.content,tru\
                e)}\"

                \          },

                \          \"deidentifyConfig\":{

                \            \"infoTypeTransformations\":{

                \              \"transformations\":[

                \                {

                \                  \"infoTypes\":[

                \                    {

                \                      \"name\":\"EMAIL_ADDRESS\"

                \                    }

                \                  ],

                \                  \"primitiveTransformation\":{

                \                    \"characterMaskConfig\":{

                \                      \"maskingCharacter\":\"*\",

                \                      \"reverseOrder\":false,

                \                      \"charactersToIgnore\":[

                \                        {

                \                          \"charactersToSkip\":\"@\"

                \                        }

                \                      ]

                \                    }

                \                  }

                \                },

                \                {

                \                  \"infoTypes\":[

                \                    {

                \                      \"name\":\"PHONE_NUMBER\"

                \                    }

                \                  ],

                \                  \"primitiveTransformation\":{

                \                    \"replaceConfig\":{

                \                      \"newValue\":{

                \                        \"stringValue\":\"[telephone-number]\"

                \                      }

                \                    }

                \                  }

                \                }

                \              ]

                \            }

                \          },

                \          \"inspectConfig\": {

                \            \"infoTypes\": [

                \              {

                \                \"name\": \"PHONE_NUMBER\"

                \              },

                \              {

                \                \"name\":\"EMAIL_ADDRESS\"

                \              }

                \            ],

                \            \"minLikelihood\": \"POSSIBLE\",

                \            \"limits\": {

                \              \"maxFindingsPerItem\": 0

                \            },

                \            \"includeQuote\": true

                \          }

                \        }

                \      "
        Response:
          _text: sensitiveDataProtectionResponse
        HTTPTargetConnection:
          Properties: {}
          URL:
            _text: https://dlp.googleapis.com/v2/projects/{propertyset.dlp.PROJECT_ID}/content:deidentify
          Authentication:
            GoogleAccessToken:
              Scopes:
                Scope:
                  _text: https://www.googleapis.com/auth/cloud-platform
resources:
  - name: SetRequest.js
    type: jsc
    content: |-
      var requestObj = request.content.asJSON;
      print("request json: "+ JSON.stringify(requestObj));

      var maskedResponseObj = JSON.parse(context.getVariable("sensitiveDataProtectionResponse.content"));
      print("sdp response json: "+ JSON.stringify(maskedResponseObj));

      if (maskedResponseObj["item"] && maskedResponseObj["item"]["value"] && requestObj && requestObj["contents"] && requestObj["contents"].length > 0) {
        requestObj["contents"][requestObj["contents"].length - 1]["parts"][requestObj["contents"][requestObj["contents"].length - 1]["parts"].length - 1]["text"] = maskedResponseObj["item"]["value"];
      }

      print("changed request json: "+ JSON.stringify(requestObj));

      context.setVariable("request.content", JSON.stringify(requestObj));
  - name: dlp.properties
    type: properties
    content: PROJECT_ID=apigee-prod13
