name: AI-Gateway-v1
type: proxy
description: API template for AI-Gateway-v1
parameters:
  - name: AUTH-Key-Header-v1.API_KEY_HEADER_NAME
    description: The header where the api key is checked.
    default: x-api-key
    examples:
      - x-api-key
      - x-apikey
  - name: Feature-LLM-MaskRequest-v1.PROJECT_ID
    displayName: DLP Project Id
    description: Configuration input for PROJECT_ID
    default: "{organization.name}"
    examples:
      - "{organization.name}"
  - name: MODEL-Gemini-v1.PROJECT_ID
    displayName: PROJECT_ID
    description: The GCP project id that should be used for the Vertex AI Gemini endpoint.
    default: "{organization.name}"
    examples:
      - "{organization.name}"
  - name: MODEL-Gemini-v1.REGION
    displayName: REGION
    description: The GCP region that should be used for the Vertex AI Gemini endpoint.
    default: "{system.region.name}"
    examples:
      - "{system.region.name}"
  - name: MODEL-Gemini-v1.MODEL_ID
    displayName: MODEL_ID
    description: The Gemini model to use for the request.
    default: gemini-2.5-flash
    examples:
      - gemini-2.5-flash
      - gemini-2.5-pro
endpoints:
  - name: gemini
    basePath: /v1/gemini
    routes:
      - name: default
        target: gemini
    flows:
      - name: PreFlow
        mode: Request
        steps:
          - name: VA-VerifyKey
            condition: request.verb != "OPTIONS"
          - name: AM-RemoveKey
            condition: request.verb != "OPTIONS"
          - name: AM-LoadQuota
            condition: request.verb != "OPTIONS"
          - name: SC-SensitiveDataProtection
          - name: JS-SetMaskedRequest
    faultRules: []
targets:
  - name: gemini
    url: https://{system.region.name}-aiplatform.googleapis.com/v1/projects/{organization.name}/locations/{system.region.name}/publishers/google/models/gemini-2.5-flash:generateContent
    auth: GoogleAccessToken
    scopes:
      - https://www.googleapis.com/auth/cloud-platform
    flows:
      - name: PostFlow
        mode: Response
        steps:
          - name: Q-UpdateQuota
          - name: EV-StoreModelInfo
      - name: EventFlow
        mode: Response
        steps: []
      - name: PreFlow
        mode: Request
        steps:
          - name: Q-CheckQuota
    faultRules: []
    httpTargetConnection:
      Properties: {}
      URL:
        _text: https://{system.region.name}-aiplatform.googleapis.com/v1/projects/{organization.name}/locations/{system.region.name}/publishers/google/models/gemini-2.5-flash:generateContent
      Authentication:
        GoogleAccessToken:
          Scopes:
            Scope:
              _text: https://www.googleapis.com/auth/cloud-platform
policies:
  - name: EV-StoreModelInfo
    type: ExtractVariables
    content:
      ExtractVariables:
        _attributes:
          continueOnError: "false"
          enabled: "true"
          name: EV-StoreModelInfo
        DisplayName:
          _text: EV-StoreModelInfo
        Properties: {}
        IgnoreUnresolvedVariables:
          _text: "true"
        Variable:
          _attributes:
            name: model
          Pattern:
            _text: gemini-2.5-flash
        JSONPayload:
          Variable:
            - _attributes:
                name: promptTokenCount
              JSONPath:
                _text: $.usage.prompt_tokens
            - _attributes:
                name: responseTokenCount
              JSONPath:
                _text: $.usage.completion_tokens
            - _attributes:
                name: totalTokenCount
              JSONPath:
                _text: $.usage.total_tokens
        Source:
          _attributes:
            clearPayload: "false"
          _text: response
        VariablePrefix:
          _text: llm
  - name: Q-CheckQuota
    type: Quota
    content:
      Quota:
        _attributes:
          continueOnError: "false"
          enabled: "true"
          name: Q-CheckQuota
        DisplayName:
          _text: Q-CheckQuota
        Properties: {}
        Identifier:
          _attributes:
            ref: client_id
        Allow:
          _attributes:
            countRef: quota.limit
        Interval:
          _attributes:
            ref: quota.interval
        TimeUnit:
          _attributes:
            ref: quota.timeunit
        MessageWeight:
          _attributes:
            ref: llm.promptEstimatedTokenCount
        Distributed:
          _text: "true"
        Synchronous:
          _text: "true"
        CountOnly:
          _text: "true"
        SharedName:
          _text: token-quota
  - name: Q-UpdateQuota
    type: Quota
    content:
      Quota:
        _attributes:
          continueOnError: "false"
          enabled: "true"
          name: Q-UpdateQuota
          type: calendar
        DisplayName:
          _text: Q-UpdateQuota
        Properties: {}
        Allow:
          _attributes:
            count: "2000"
            countRef: request.header.allowed_quota
        Interval:
          _attributes:
            ref: request.header.quota_count
          _text: "1"
        Distributed:
          _text: "false"
        Synchronous:
          _text: "false"
        TimeUnit:
          _attributes:
            ref: request.header.quota_timeout
          _text: month
        StartTime:
          _text: 2013-08-21 10:00:00
        AsynchronousConfiguration:
          SyncIntervalInSeconds:
            _text: "20"
          SyncMessageCount:
            _text: "5"
  - name: JS-SetMaskedRequest
    type: Javascript
    content:
      Javascript:
        _attributes:
          continueOnError: "false"
          enabled: "true"
          timeLimit: "200"
          name: JS-SetMaskedRequest
        DisplayName:
          _text: JS-SetMaskedRequest
        Properties: {}
        ResourceURL:
          _text: jsc://SetRequest.js
  - name: SC-SensitiveDataProtection
    type: ServiceCallout
    content:
      ServiceCallout:
        _attributes:
          continueOnError: "false"
          enabled: "true"
          name: SC-SensitiveDataProtection
        DisplayName:
          _text: SC-SensitiveDataProtection
        Properties: {}
        Request:
          _attributes:
            clearPayload: "true"
            variable: myRequest
          IgnoreUnresolvedVariables:
            _text: "false"
          Set:
            Verb:
              _text: POST
            Payload:
              _attributes:
                contentType: application/json
              _text: "

                \        {

                \          \"item\": {

                \            \"value\":
                \"{jsonPath('$.contents[-1].parts[-1].text',request.content,tru\
                e)}\"

                \          },

                \          \"deidentifyConfig\":{

                \            \"infoTypeTransformations\":{

                \              \"transformations\":[

                \                {

                \                  \"infoTypes\":[

                \                    {

                \                      \"name\":\"EMAIL_ADDRESS\"

                \                    }

                \                  ],

                \                  \"primitiveTransformation\":{

                \                    \"characterMaskConfig\":{

                \                      \"maskingCharacter\":\"*\",

                \                      \"reverseOrder\":false,

                \                      \"charactersToIgnore\":[

                \                        {

                \                          \"charactersToSkip\":\"@\"

                \                        }

                \                      ]

                \                    }

                \                  }

                \                },

                \                {

                \                  \"infoTypes\":[

                \                    {

                \                      \"name\":\"PHONE_NUMBER\"

                \                    }

                \                  ],

                \                  \"primitiveTransformation\":{

                \                    \"replaceConfig\":{

                \                      \"newValue\":{

                \                        \"stringValue\":\"[telephone-number]\"

                \                      }

                \                    }

                \                  }

                \                }

                \              ]

                \            }

                \          },

                \          \"inspectConfig\": {

                \            \"infoTypes\": [

                \              {

                \                \"name\": \"PHONE_NUMBER\"

                \              },

                \              {

                \                \"name\":\"EMAIL_ADDRESS\"

                \              }

                \            ],

                \            \"minLikelihood\": \"POSSIBLE\",

                \            \"limits\": {

                \              \"maxFindingsPerItem\": 0

                \            },

                \            \"includeQuote\": true

                \          }

                \        }

                \      "
        Response:
          _text: sensitiveDataProtectionResponse
        HTTPTargetConnection:
          Properties: {}
          URL:
            _text: https://dlp.googleapis.com/v2/projects/{organization.name}/content:deidentify
          Authentication:
            GoogleAccessToken:
              Scopes:
                Scope:
                  _text: https://www.googleapis.com/auth/cloud-platform
  - name: AM-LoadQuota
    type: AssignMessage
    content:
      AssignMessage:
        _attributes:
          continueOnError: "false"
          enabled: "true"
          name: AM-LoadQuota
        DisplayName:
          _text: AM-LoadQuota
        Properties: {}
        AssignVariable:
          - Name:
              _text: quota.limit
            Ref:
              _text: verifyapikey.VA-VerifyKey.apiproduct.developer.quota.limit
          - Name:
              _text: quota.interval
            Ref:
              _text: verifyapikey.VA-VerifyKey.apiproduct.developer.quota.interval
          - Name:
              _text: quota.timeunit
            Ref:
              _text: verifyapikey.VA-VerifyKey.apiproduct.developer.quota.timeunit
        IgnoreUnresolvedVariables:
          _text: "true"
  - name: AM-RemoveKey
    type: AssignMessage
    content:
      AssignMessage:
        _attributes:
          continueOnError: "false"
          enabled: "true"
          name: AM-RemoveKey
        DisplayName:
          _text: AM-RemoveKey
        Properties: {}
        Remove:
          Headers:
            Header:
              _attributes:
                name: x-api-key
        IgnoreUnresolvedVariables:
          _text: "true"
        AssignTo:
          _attributes:
            createNew: "false"
            transport: http
            type: request
  - name: VA-VerifyKey
    type: VerifyAPIKey
    content:
      VerifyAPIKey:
        _attributes:
          continueOnError: "false"
          enabled: "true"
          name: VA-VerifyKey
        DisplayName:
          _text: VA-VerifyKey
        Properties: {}
        APIKey:
          _attributes:
            ref: request.header.x-api-key
resources:
  - name: SetRequest.js
    type: jsc
    content: |-
      var requestObj = request.content.asJSON;
      print("request json: "+ JSON.stringify(requestObj));

      var maskedResponseObj = JSON.parse(context.getVariable("sensitiveDataProtectionResponse.content"));
      print("sdp response json: "+ JSON.stringify(maskedResponseObj));

      if (maskedResponseObj["item"] && maskedResponseObj["item"]["value"] && requestObj && requestObj["contents"] && requestObj["contents"].length > 0) {
        requestObj["contents"][requestObj["contents"].length - 1]["parts"][requestObj["contents"][requestObj["contents"].length - 1]["parts"].length - 1]["text"] = maskedResponseObj["item"]["value"];
      }

      print("changed request json: "+ JSON.stringify(requestObj));

      context.setVariable("request.content", JSON.stringify(requestObj));
