name: llm-token-quota
type: feature
description: |-
  This feature estimates the token length of an input prompt, checks
  the quota in the target pre-flow, and then updates the token in the target
  post-flow.
priority: 150
parameters: []
defaultEndpoint:
  name: default
  basePath: /feature-llm-tokenquota-v1
  routes:
    - name: default
      target: default
  flows: []
  faultRules: []
defaultTarget:
  name: default
  url: https://httpbin.org
  flows:
    - name: PreFlow
      mode: Request
      steps:
        - name: Q-CheckQuota
          condition: quota.limit != null
    - name: PostFlow
      mode: Response
      steps:
        - name: Q-UpdateQuota
          condition: quota.limit != null
    - name: EventFlow
      mode: Response
      steps: []
  faultRules: []
  httpTargetConnection:
    URL:
      _text: https://httpbin.org
endpoints: []
targets: []
policies:
  - name: Q-CheckQuota
    type: Quota
    content:
      Quota:
        _attributes:
          continueOnError: "false"
          enabled: "true"
          name: Q-CheckQuota
        DisplayName:
          _text: Q-CheckQuota
        Properties: {}
        Identifier:
          _attributes:
            ref: client_id
        Allow:
          _attributes:
            countRef: quota.limit
        Interval:
          _attributes:
            ref: quota.interval
        TimeUnit:
          _attributes:
            ref: quota.timeunit
        MessageWeight:
          _attributes:
            ref: llm.promptEstimatedTokenCount
        Distributed:
          _text: "true"
        Synchronous:
          _text: "true"
        CountOnly:
          _text: "true"
        SharedName:
          _text: token-quota
  - name: Q-UpdateQuota
    type: Quota
    content:
      Quota:
        _attributes:
          continueOnError: "false"
          enabled: "true"
          name: Q-UpdateQuota
          type: calendar
        DisplayName:
          _text: Q-UpdateQuota
        Properties: {}
        Allow:
          _attributes:
            count: "2000"
            countRef: request.header.allowed_quota
        Interval:
          _attributes:
            ref: request.header.quota_count
          _text: "1"
        Distributed:
          _text: "false"
        Synchronous:
          _text: "false"
        TimeUnit:
          _attributes:
            ref: request.header.quota_timeout
          _text: month
        StartTime:
          _text: 2013-08-21 10:00:00
        AsynchronousConfiguration:
          SyncIntervalInSeconds:
            _text: "20"
          SyncMessageCount:
            _text: "5"
resources: []
tests: []
