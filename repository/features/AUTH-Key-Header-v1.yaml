name: AUTH-Key-Header-v1
type: feature
description: |
  This feature applies API key header authentication and authorization to the proxy flow.

  ## Prerequisites
  None.

  ## Inputs
  - An API product configured for the current proxy, optionally with quota information.

  ## Outputs
  - If the key is not found in the configured header, or is not valid for the current call, then a fault is raised with response code 401.
  - If quota information is found, it is loaded into the **Apigee variables quota.limit, quota.interval, and quota.timeunit**.
priority: 1
parameters:
  - name: API_KEY_HEADER_NAME
    description: The header where the api key is checked.
    default: x-api-key
    examples:
      - x-api-key
      - x-apikey
endpointFlows:
  - name: PreFlow
    mode: Request
    steps:
      - name: VA-VerifyKey
        condition: request.verb != "OPTIONS"
      - name: AM-RemoveKey
        condition: request.verb != "OPTIONS"
      - name: AM-LoadQuota
        condition: request.verb != "OPTIONS"
targetFlows: []
endpoints: []
targets: []
policies:
  - name: AM-LoadQuota
    type: AssignMessage
    content:
      AssignMessage:
        _attributes:
          continueOnError: "false"
          enabled: "true"
          name: AM-LoadQuota
        DisplayName:
          _text: AM-LoadQuota
        Properties: {}
        AssignVariable:
          - Name:
              _text: quota.limit
            Ref:
              _text: verifyapikey.VA-VerifyKey.apiproduct.developer.quota.limit
          - Name:
              _text: quota.interval
            Ref:
              _text: verifyapikey.VA-VerifyKey.apiproduct.developer.quota.interval
          - Name:
              _text: quota.timeunit
            Ref:
              _text: verifyapikey.VA-VerifyKey.apiproduct.developer.quota.timeunit
        IgnoreUnresolvedVariables:
          _text: "true"
  - name: AM-RemoveKey
    type: AssignMessage
    content:
      AssignMessage:
        _attributes:
          continueOnError: "false"
          enabled: "true"
          name: AM-RemoveKey
        DisplayName:
          _text: AM-RemoveKey
        Properties: {}
        Remove:
          Headers:
            Header:
              _attributes:
                name: "{API_KEY_HEADER_NAME}"
        IgnoreUnresolvedVariables:
          _text: "true"
        AssignTo:
          _attributes:
            createNew: "false"
            transport: http
            type: request
  - name: VA-VerifyKey
    type: VerifyAPIKey
    content:
      VerifyAPIKey:
        _attributes:
          continueOnError: "false"
          enabled: "true"
          name: VA-VerifyKey
        DisplayName:
          _text: VA-VerifyKey
        Properties: {}
        APIKey:
          _attributes:
            ref: request.header.{API_KEY_HEADER_NAME}
resources: []
