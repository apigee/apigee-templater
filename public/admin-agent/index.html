<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Apigee Agentic Portal</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            a:link {
                color: var(--text-primary);
            }

            /* visited link */
            a:visited {
                color: var(--text-primary);
            }

            /* mouse over link */
            a:hover {
                color: var(--text-primary);
            }

            /* selected link */
            a:active {
                color: var(--text-primary);
            }

            :root {
                /* Dark mode colors */
                --bg-primary: #0f172a;
                --bg-secondary: #1e293b;
                --bg-tertiary: #334155;
                --text-primary: #f8fafc;
                --text-secondary: #cbd5e1;
                --text-tertiary: #64748b;
                --border: #334155;
                --shadow: rgba(0, 0, 0, 0.3);
                --accent: #60a5fa;
                --accent-hover: #3b82f6;
                --user-bg: #3b82f6;
                --user-text: #ffffff;
                --ai-bg: #1e293b;
                --ai-text: #f8fafc;
                --input-bg: #1e293b;
                --header-bg: rgba(15, 23, 42, 0.8);
            }

            [data-theme="light"] {
                /* Light mode colors */
                --bg-primary: #ffffff;
                --bg-secondary: #f8fafc;
                --bg-tertiary: #f1f5f9;
                --text-primary: #0f172a;
                --text-secondary: #475569;
                --text-tertiary: #94a3b8;
                --border: #e2e8f0;
                --shadow: rgba(0, 0, 0, 0.05);
                --accent: #3b82f6;
                --accent-hover: #2563eb;
                --user-bg: #3b82f6;
                --user-text: #ffffff;
                --ai-bg: #f1f5f9;
                --ai-text: #0f172a;
                --input-bg: #ffffff;
                --header-bg: rgba(255, 255, 255, 0.8);
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter",
                    system-ui, sans-serif;
                background-color: var(--bg-primary);
                color: var(--text-primary);
                transition:
                    background-color 0.3s ease,
                    color 0.3s ease;
                line-height: 1.5;
                font-size: 16px;
            }

            .app-container {
                max-width: 900px;
                margin: 0 auto;
                height: 100vh;
                display: flex;
                flex-direction: column;
                background-color: var(--bg-primary);
            }

            .header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 16px 24px;
                border-bottom: 1px solid var(--border);
                background-color: var(--header-bg);
                backdrop-filter: blur(8px);
                position: sticky;
                top: 0;
                z-index: 10;
            }

            .header-left {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .logo {
                width: 32px;
                height: 32px;
                background: var(--accent);
                border-radius: 6px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 600;
                font-size: 14px;
            }

            .app-title {
                font-size: 18px;
                font-weight: 600;
                color: var(--text-primary);
            }

            .theme-toggle {
                background: none;
                border: 1px solid var(--border);
                border-radius: 8px;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                color: var(--text-secondary);
                transition: all 0.2s ease;
            }

            .theme-toggle:hover {
                background-color: var(--bg-secondary);
                color: var(--text-primary);
            }

            .chat-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            .messages {
                flex: 1;
                overflow-y: auto;
                padding: 24px;
                scroll-behavior: smooth;
            }

            .messages::-webkit-scrollbar {
                width: 4px;
            }

            .messages::-webkit-scrollbar-track {
                background: transparent;
            }

            .messages::-webkit-scrollbar-thumb {
                background: var(--border);
                border-radius: 2px;
            }

            .message {
                margin-bottom: 24px;
                display: flex;
                gap: 12px;
                opacity: 0;
                animation: fadeInUp 0.4s ease-out forwards;
            }

            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(8px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .message.user {
                flex-direction: row-reverse;
            }

            .avatar {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                font-weight: 600;
                flex-shrink: 0;
                margin-top: 2px;
            }

            .avatar.user {
                background: var(--user-bg);
                color: var(--user-text);
            }

            .avatar.ai {
                background: var(--bg-secondary);
                color: var(--text-secondary);
                border: 1px solid var(--border);
            }

            .message-content {
                max-width: calc(100% - 48px);
                background: var(--ai-bg);
                color: var(--ai-text);
                padding: 12px 26px;
                border-radius: 12px;
                font-size: 15px;
                line-height: 1.6;
                border: 1px solid var(--border);
            }

            .message.user .message-content {
                background: var(--user-bg);
                color: var(--user-text);
                border: none;
            }

            .typing-indicator {
                display: none;
                align-items: center;
                gap: 12px;
                margin: 0 24px 24px 24px;
            }

            .typing-dots {
                display: flex;
                gap: 4px;
                padding: 12px 16px;
                background: var(--ai-bg);
                border-radius: 12px;
                border: 1px solid var(--border);
            }

            .typing-dot {
                width: 6px;
                height: 6px;
                background: var(--text-tertiary);
                border-radius: 50%;
                animation: pulse 1.5s ease-in-out infinite;
            }

            .typing-dot:nth-child(2) {
                animation-delay: 0.2s;
            }

            .typing-dot:nth-child(3) {
                animation-delay: 0.4s;
            }

            @keyframes pulse {
                0%,
                60%,
                100% {
                    opacity: 0.3;
                    transform: scale(0.8);
                }
                30% {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            .input-area {
                padding: 16px 24px;
                border-top: 1px solid var(--border);
                background: var(--bg-primary);
            }

            .input-container {
                display: flex;
                gap: 12px;
                align-items: flex-end;
                max-width: 100%;
            }

            .message-input {
                flex: 1;
                background: var(--input-bg);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 12px 16px;
                font-size: 15px;
                color: var(--text-primary);
                resize: none;
                outline: none;
                transition: all 0.2s ease;
                min-height: 44px;
                max-height: 120px;
                font-family: inherit;
                line-height: 1.4;
                overflow: hidden;
            }

            .message-input::placeholder {
                color: var(--text-tertiary);
            }

            .message-input:focus {
                border-color: var(--accent);
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }

            .send-button {
                background: var(--accent);
                border: none;
                border-radius: 10px;
                width: 44px;
                height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                color: white;
                transition: all 0.2s ease;
                flex-shrink: 0;
            }

            .send-button:hover:not(:disabled) {
                background: var(--accent-hover);
                transform: translateY(-1px);
            }

            .send-button:active {
                transform: translateY(0);
            }

            .send-button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }

            .welcome-message {
                text-align: center;
                color: var(--text-secondary);
                font-size: 18px;
                margin: 60px 20px;
                line-height: 1.6;
            }

            .welcome-title {
                font-size: 34px;
                font-weight: 600;
                color: var(--text-primary);
                margin-bottom: 8px;
            }

            @media (max-width: 768px) {
                .app-container {
                    height: calc(100vh - 124px);
                }

                .header {
                    padding: 12px 16px;
                }

                .messages {
                    padding: 16px;
                }

                .input-area {
                    padding: 12px 16px;
                }

                .message-content {
                    max-width: calc(100% - 48px);
                    font-size: 14px;
                }

                .welcome-message {
                    margin: 40px 16px;
                }
            }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js"></script>
    </head>
    <body>
        <div class="app-container">
            <div class="chat-container">
                <div class="messages" id="messages">
                    <div class="welcome-message">
                        <div class="welcome-title">Apigee Admin Agent</div>
                        I'm here to help you with creating and managing API
                        templates, features & proxies.
                    </div>
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    <div class="avatar ai">AI</div>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>

                <div class="input-area">
                    <div class="input-container">
                        <textarea
                            class="message-input"
                            id="messageInput"
                            placeholder="Message Apigee..."
                            rows="1"
                            autofocus
                        ></textarea>
                        <button
                            class="send-button"
                            id="sendButton"
                            aria-label="Send message"
                        >
                            <svg
                                width="20"
                                height="20"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path d="M22 2L11 13" />
                                <path d="M22 2L15 22L11 13L2 9L22 2z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            class ChatInterface {
                oauthMessage = {};

                constructor() {
                    this.messages = document.getElementById("messages");
                    this.messageInput = document.getElementById("messageInput");
                    this.sendButton = document.getElementById("sendButton");
                    this.typingIndicator =
                        document.getElementById("typingIndicator");
                    this.themeToggle = document.getElementById("themeToggle");
                    this.lightIcon = document.getElementById("lightIcon");
                    this.darkIcon = document.getElementById("darkIcon");
                    this.config = {};
                    this.isTyping = false;
                    this.user_email = localStorage.getItem("user_email");
                    this.user_session = "api-publisher-portal";
                    // this.user_session =
                    //     "s_" + Math.floor(Math.random() * 10000).toString();

                    this.initTheme();
                    this.setupEventListeners();
                    this.autoResizeTextarea();
                    this.startSession();
                }

                async startSession() {
                    let configResponse = await fetch("/config");
                    if (configResponse.status == 200) {
                        this.config = await configResponse.json();
                    } else
                        console.error(
                            "Could not load agent config: " +
                                configResponse.status,
                        );
                    let sessionResponse = await fetch(
                        this.config.apigeeAgentUrl +
                            `/apps/apigee_templater_agent/users/${this.user_email}/sessions/${this.user_session}`,
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                        },
                    );

                    let responseText = await sessionResponse.text();
                    console.log(responseText);
                    let authCodeResult = await this.onAuthorizationCode();
                    //if (!authCodeResult) this.onAuthorizationCode();
                }

                initTheme() {
                    const savedTheme = localStorage.getItem("theme") || "dark";
                    this.setTheme(savedTheme);
                }

                setTheme(theme) {
                    document.documentElement.setAttribute("data-theme", theme);
                    localStorage.setItem("theme", theme);

                    // if (theme === "dark") {
                    //     this.lightIcon.style.display = "none";
                    //     this.darkIcon.style.display = "block";
                    // } else {
                    //     this.lightIcon.style.display = "block";
                    //     this.darkIcon.style.display = "none";
                    // }
                }

                toggleTheme() {
                    const currentTheme =
                        document.documentElement.getAttribute("data-theme");
                    const newTheme = currentTheme === "dark" ? "light" : "dark";
                    this.setTheme(newTheme);
                }

                setupEventListeners() {
                    this.sendButton.addEventListener("click", () =>
                        this.sendMessage(),
                    );
                    // this.themeToggle.addEventListener("click", () =>
                    //     this.toggleTheme(),
                    // );

                    this.messageInput.addEventListener("keydown", (e) => {
                        if (e.key === "Enter" && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });

                    this.messageInput.addEventListener("input", () => {
                        this.autoResizeTextarea();
                    });
                }

                autoResizeTextarea() {
                    this.messageInput.style.height = "auto";
                    this.messageInput.style.height =
                        Math.min(this.messageInput.scrollHeight, 120) + "px";
                }

                async sendMessage() {
                    const text = this.messageInput.value.trim();
                    if (!text) return;

                    this.addMessage(text, "user");
                    this.messageInput.value = "";
                    this.autoResizeTextarea();
                    this.showTypingIndicator();

                    await this.generateResponse(text);
                }

                addMessage(text, sender) {
                    const messageDiv = document.createElement("div");
                    messageDiv.className = `message ${sender}`;

                    const avatar = document.createElement("div");
                    avatar.className = `avatar ${sender}`;
                    avatar.textContent = sender === "user" ? "U" : "AI";

                    const content = document.createElement("div");
                    content.className = "message-content";
                    content.textContent = text;

                    messageDiv.appendChild(avatar);
                    messageDiv.appendChild(content);

                    this.messages.appendChild(messageDiv);
                    this.scrollToBottom();
                }

                showTypingIndicator() {
                    this.typingIndicator.style.display = "flex";
                    this.scrollToBottom();
                }

                hideTypingIndicator() {
                    this.typingIndicator.style.display = "none";
                }

                async generateResponse(userMessage) {
                    let result = true;
                    try {
                        let newResponse = await fetch(
                            this.config.apigeeAgentUrl + "/run",
                            {
                                method: "POST",
                                signal: AbortSignal.timeout(25000),
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({
                                    app_name: "apigee_templater_agent",
                                    user_id: this.user_email,
                                    session_id: this.user_session,
                                    new_message: {
                                        role: "user",
                                        parts: [
                                            {
                                                text: userMessage,
                                            },
                                        ],
                                    },
                                    streaming: false,
                                }),
                            },
                        );

                        if (newResponse.status == 200) {
                            let responseJson = await newResponse.json();
                            this.processResponse(responseJson);
                        } else {
                            console.log(
                                "Error calling ADK: " + newResponse.status,
                            );
                        }
                    } catch (e) {
                        result = false;
                        // this.hideTypingIndicator();
                        let seconds = Math.floor(Math.random() * 100) + 1;
                        await this.typeMessage(
                            `Hmm, it looks like I went to sleep and need to wake up my Python! Give me ${seconds} seconds...`,
                            "ai",
                        );

                        return this.generateResponse(userMessage);
                    }

                    return result;
                }

                async processResponse(agentResponse) {
                    for (let response of agentResponse) {
                        if (
                            response["content"] &&
                            response["content"]["parts"] &&
                            response["content"]["parts"][0] &&
                            response["content"]["parts"][0]["text"]
                        ) {
                            await this.typeMessage(
                                response["content"]["parts"][0]["text"],
                                "ai",
                            );
                        } else if (
                            response["content"] &&
                            response["content"]["parts"] &&
                            response["content"]["parts"][0]["functionCall"] &&
                            response["content"]["parts"][0]["functionCall"] &&
                            response["content"]["parts"][0]["functionCall"][
                                "args"
                            ] &&
                            response["content"]["parts"][0]["functionCall"][
                                "args"
                            ]["authConfig"]
                        ) {
                            this.oauthMessage =
                                response["content"]["parts"][0]["functionCall"];
                            localStorage.setItem(
                                "oauthMessage",
                                JSON.stringify(this.oauthMessage),
                            );
                            setTimeout(() => {
                                var event = new CustomEvent("oauth_redirect", {
                                    detail: this.oauthMessage,
                                });
                                window.parent.document.dispatchEvent(event);
                            }, 3000);
                        }
                    }

                    this.hideTypingIndicator();
                }

                async typeMessage(text, sender) {
                    if (this.isTyping) {
                        this.isTyping = false;
                        await new Promise((resolve) =>
                            setTimeout(resolve, 200),
                        );
                    }

                    const messageDiv = document.createElement("div");
                    messageDiv.className = `message ${sender}`;

                    const avatar = document.createElement("div");
                    avatar.className = `avatar ${sender}`;
                    avatar.textContent = sender === "user" ? "U" : "AI";

                    const content = document.createElement("div");
                    content.className = "message-content";

                    messageDiv.appendChild(avatar);
                    messageDiv.appendChild(content);
                    this.messages.appendChild(messageDiv);
                    this.isTyping = true;
                    console.log(text.length);
                    let begin = 0;
                    if (text.length > 100) {
                        content.innerHTML = marked.parse(
                            text.substring(0, text.length - 100),
                        );
                        begin = text.length - 100;
                    }
                    for (let i = begin; i <= text.length; i++) {
                        // content.textContent = text.substring(0, i);
                        content.innerHTML = marked.parse(text.substring(0, i));
                        this.scrollToBottom();
                        await new Promise((resolve) => setTimeout(resolve, 20));
                        if (!this.isTyping) break;
                    }
                    this.isTyping = false;
                }

                scrollToBottom() {
                    this.messages.scrollTop = this.messages.scrollHeight;
                }

                async onAuthorizationCode() {
                    let code = localStorage.getItem("authorization_code");
                    let auth_response_rui =
                        localStorage.getItem("auth_response_uri");
                    let oauthMessage = localStorage.getItem("oauthMessage");
                    let result = true;
                    if (oauthMessage && code) {
                        try {
                            this.oauthMessage = JSON.parse(
                                localStorage.getItem("oauthMessage"),
                            );
                            this.oauthMessage["args"]["authConfig"][
                                "exchangedAuthCredential"
                            ]["oauth2"]["auth_response_uri"] =
                                auth_response_rui;

                            let authRequestFunctionCallId =
                                this.oauthMessage["id"];
                            let oauthResponseBody = {
                                app_name: "apigee_templater_agent",
                                user_id: this.user_email,
                                session_id: this.user_session,
                                new_message: {
                                    role: "user",
                                    parts: [
                                        {
                                            functionResponse: {
                                                id: authRequestFunctionCallId,
                                                name: "adk_request_credential",
                                                response:
                                                    this.oauthMessage["args"][
                                                        "authConfig"
                                                    ],
                                            },
                                        },
                                    ],
                                },
                                streaming: false,
                            };
                            console.log(oauthResponseBody);

                            let newResponse = await fetch(
                                this.config.apigeeAgentUrl + "/run",
                                {
                                    method: "POST",
                                    signal: AbortSignal.timeout(5000),
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify(oauthResponseBody),
                                },
                            );

                            if (newResponse.status == 200) {
                                let responseJson = await newResponse.json();
                                this.processResponse(responseJson);
                            }

                            localStorage.removeItem("auth_response_uri");
                            localStorage.removeItem("authorization_code");
                            localStorage.removeItem("oauthMessage");
                        } catch (e) {
                            result = false;
                        }
                    } else {
                        this.generateResponse("Greet me.");
                        // let result = await this.generateResponse(
                        //     "Give a short overview of your capabilities.",
                        // );
                        // if (!result) {
                        //     this.generateResponse(
                        //         "Give a short overview of your capabilities.",
                        //     );
                        // }
                    }

                    return result;
                }
            }

            new ChatInterface();
        </script>
    </body>
</html>
